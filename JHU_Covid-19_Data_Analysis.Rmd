---
title: "Johns Hopkins Covid-19 Data Analysis"
date: "06/20/2023"
output:
  rmdformats::readthedown:
    highlight: kate
---
## Setup: 
```{r}
suppressPackageStartupMessages({
    library(tidyverse)
    library(lubridate)
    library(ggplot2)
    library(leaflet)
    library(gganimate)
    library(gifski)
    library(maps)
})
confirmed_us <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv")
confirmed_global <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
death_us <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv")
death_global <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")

options(scipen = 100)
```

## Cleaning the data:

```{r}
confirmed_global$Key <- paste0(confirmed_global$Province.State, confirmed_global$Country.Region)
death_global$Key <- paste0(death_global$Province.State,death_global$Country.Region)

us_data <- left_join(confirmed_us, death_us, by = "Combined_Key", suffix = c(".case",".death"))
global_data <- left_join(confirmed_global, death_global, by = "Key", suffix = c(".case",".death"))

us_data$case_sum <- us_data$X3.9.23.case
# us_data$case_sum[us_data$case_sum>100000] <- 100000
us_data$case_rate <- (us_data$case_sum/us_data$Population)*100000
us_data$case_rate <- ifelse(us_data$case_rate==0 | is.nan(us_data$case_rate) | us_data$case_rate==Inf, yes = 0, no = us_data$case_rate)
```


## Visualization: 

```{r}
us_map <- map_data("county")
us_map$Combined_Key <- toupper(paste(us_map$subregion, us_map$region, "US", sep = ", "))
us_data$Combined_Key <- toupper(us_data$Combined_Key)


us_map <- left_join(us_map, us_data, by = "Combined_Key")

us_map$case_rate2 <- us_map$case_rate
us_map$case_rate2[us_map$case_rate2>100000] <- 100000

map1 <- ggplot(data = us_map, aes(x = long, y = lat, group = group, fill = case_rate2))+
  geom_polygon(color = "white", linewidth = .001)+
  coord_quickmap()+
  # scale_fill_gradient2(low = "#ffeda0",mid = "#feb24c", high = "#f03b20", midpoint = mean(us_data$case_rate)/3)
  scale_fill_viridis_c(option = "rocket", direction = -1, name = "Cases per 100K", labels = c("0","25,000","50,000","75,000","100,000+"))+
  theme_void()+
  ggtitle("US Counties by Cases per 100K population")+
  theme(plot.title = element_text(hjust = 0.5))

map1
```

```{r}
tarrant_data <- us_data[us_data$Admin2.case=="Tarrant",]

tarrant_cases <- tarrant_data[,grepl(".case",colnames(tarrant_data))]
tarrant_cases <- pivot_longer(tarrant_cases,cols = c(11:1153))
tarrant_cases$Date_final <- gsub("X|.case","",tarrant_cases$name)
tarrant_cases$Date_final<- as.Date(tarrant_cases$Date_final, format = "%m.%d.%y")

tarrant_deaths <- tarrant_data[,grepl(".death",colnames(tarrant_data))]
tarrant_deaths <- pivot_longer(tarrant_deaths,cols = c(11:1153))
tarrant_deaths$Date_final <- gsub("X|.death","",tarrant_deaths$name)
tarrant_deaths$Date_final <- as.Date(tarrant_deaths$Date_final, format = "%m.%d.%y")

key_date <- c("2020-03-12","2020-10-11","2021-07-14","2021-12-08","2022-06-02","2022-12-02")
tarrant_key_dates <- data.frame(key_date)
tarrant_key_dates$key_date <- as.Date(tarrant_key_dates$key_date,format = "%Y-%m-%d")
tarrant_key_dates$Count <- tarrant_cases$value[tarrant_cases$Date_final %in% tarrant_key_dates$key_date]

chart1 <- suppressWarnings({ ggplot()+
  geom_line(data = tarrant_cases,aes(x = Date_final , y = value), color = "blue", size = 1)+
  geom_line(data = tarrant_deaths,aes(x = Date_final, y = value), color = "red", size = 1)+
  geom_point(data = tarrant_key_dates, aes(x = key_date, y = Count), color = "black", size = 3)+
  geom_text(data = tarrant_key_dates, aes(x = key_date, y = Count, label = key_date), hjust = 0, vjust = 1.4)+
  ylim(-10000,700000)+
  ylab("Number of Cases and Deaths")+
  xlab("Date")+
  ggtitle("Tarrant County Covid-19 Case and Death Counts")+
  theme(plot.title = element_text(hjust = 0.5))
})
chart1
```

Let's look at percent of total population in recovered, deaths, uninfected, active
```{r}
global_case_long <- pivot_longer(confirmed_global,cols = c(5:1147))
global_case_long$date_final <- as.Date(gsub("X","",global_case_long$name),format = "%m.%d.%y")
global_death_long <- pivot_longer(death_global, cols = c(5:1147))
global_death_long$date_final <- as.Date(gsub("X","",global_death_long$name),format = "%m.%d.%y")
total_data_comb <- as.data.frame(matrix(data = NA, nrow = 1143, ncol = 5))
colnames(total_data_comb) <- c("final_date","active","deaths","recovered","uninfected")
total_data_comb$final_date <- tarrant_cases$Date_final

# for(i in 1:nrow(total_data_comb)){
#  total_data_comb$deaths[i]<- sum(global_death_long$value[global_death_long$date_final==total_data_comb$final_date[i]])
#  total_data_comb$recovered[i] <- sum(global_case_long$value[global_case_long$date_final==total_data_comb$final_date[i]-30])
#  total_data_comb$active[i] <- sum(global_case_long$value[global_case_long$date_final==total_data_comb$final_date[i]])-total_data_comb$recovered[i]
#  if(i ==1){
#    total_data_comb$uninfected[i] <- 7888000000
#  } else {
#    total_data_comb$uninfected[i] <- 7888000000-total_data_comb$active[i]-total_data_comb$deaths[i]-total_data_comb$recovered[i]
#  }
# }
# total_data_comb$uninfected <- 7888000000
# ggplot(data = total_data_comb)+
#   geom_line(aes(x = final_date, y = uninfected),color = "gray")+
#   geom_area(aes(x = final_date, y = uninfected), fill = "gray")+
#   geom_line(aes(x = final_date, y = recovered),color = "green")+
#   geom_area(aes(x = final_date, y = recovered),fill = "green")+
#   geom_line(aes(x = final_date, y = active),color = "blue")+
#   geom_area(aes(x = final_date, y = active),fill = "blue")+
#   geom_line(aes(x = final_date, y = deaths),color = "black")+
#   geom_area(aes(x = final_date, y = deaths),fill = "black")+
#   ylim(0,7888000000)


# us_case_long <- us_data[us_data$Admin2.case=="Tarrant",]

us_case_long <- us_data[,grepl(".case",colnames(us_data))]
us_case_long <- pivot_longer(us_case_long,cols = c(11:1153))
us_case_long$Date_final <- gsub("X|.case","",us_case_long$name)
us_case_long$Date_final <- as.Date(us_case_long$Date_final, format = "%m.%d.%y")

us_deaths_long <- us_data[,grepl(".death",colnames(us_data))]
us_deaths_long <- pivot_longer(us_deaths_long,cols = c(11:1153))
us_deaths_long$Date_final <- gsub("X|.death","",us_deaths_long$name)
us_deaths_long$Date_final <- as.Date(us_deaths_long$Date_final, format = "%m.%d.%y")

us_data_comb <- as.data.frame(matrix(data = NA, nrow = 1143, ncol = 5))
colnames(us_data_comb) <- c("final_date","active","deaths","recovered","uninfected")
us_data_comb$final_date <- tarrant_cases$Date_final

us_data_comb$Rt <- NA
for(i in 1:nrow(us_data_comb)){
 us_data_comb$deaths[i]<- sum(us_deaths_long$value[us_deaths_long$Date_final==us_data_comb$final_date[i]])
 us_data_comb$recovered[i] <- sum(us_case_long$value[us_case_long$Date_final==us_data_comb$final_date[i]-30])
 us_data_comb$active[i] <- sum(us_case_long$value[us_case_long$Date_final==us_data_comb$final_date[i]])-us_data_comb$recovered[i]
 us_data_comb$cases[i] <- sum(us_case_long$value[us_case_long$Date_final==us_data_comb$final_date[i]])
 if(i==1){
   us_data_comb$Rt[i] <- 0
 }else {
 us_data_comb$Rt[i] <- (us_data_comb$cases[i]-us_data_comb$cases[i-1])/((us_data_comb$recovered[i]-us_data_comb$recovered[i-1])+(us_data_comb$deaths[i]-us_data_comb$deaths[i-1]))
 }
 us_data_comb$Rt7 <-
}

us_data_comb$uninfected <- 331900000

chart2 <- ggplot(data = us_data_comb)+
  geom_area(aes(x = final_date, y = uninfected, color = "uninfected", fill = "uninfected"))+
  geom_area(aes(x = final_date, y = recovered, color = "recovered", fill = "recovered"))+
  geom_area(aes(x = final_date, y = active, color = "active", fill = "active"))+
  geom_area(aes(x = final_date, y = deaths, color = "deaths", fill ="deaths"))+
  scale_color_manual(name='Legend',
                     labels = c("Active","Deaths","Recovered","Uninfected"),
                     values=c(uninfected="black", recovered="darkgreen", active="darkblue", deaths="red"))+
  scale_fill_manual(name='Legend',
                    labels = c("Active","Deaths","Recovered","Uninfected"),
                     values=c(uninfected="black", recovered="darkgreen", active="darkblue", deaths="red"))+
  ylim(0,332000000)+
  xlab("Date (2020-01-22 to 2023-03-09)")+
  ylab("")+
  theme_minimal()+
  ggtitle("US Disease Status Over Time")+
  theme(plot.title = element_text(hjust = .5))

chart2




```


## Analysis: 

```{r}


```

